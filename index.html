<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cursos de Desenvolvimento de Software - Brasil - DevGuia</title>
    <link rel="icon" type="image/png" href="./favicon.ico">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        * {
            box-sizing: border-box;
        }

        body { 
            font-family: Arial, sans-serif; 
            margin: 10px; 
            color: #fff; 
            font-size: 14px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .header h1 {
            margin: 0;
            flex: 1;
            font-size: 1.5rem;
            min-width: 250px;
        }
        
        .logo-container {
            flex-shrink: 0;
            margin-left: 10px;
        }
        
        .logo-container img {
            height: 150px;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }
        
        .logo-container img:hover {
            opacity: 0.8;
        }

        .filters {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 150px;
        }

        .filters label {
            font-weight: bold;
            font-size: 12px;
        }

        .filters select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        .message {
            margin-top: 10px;
            font-style: italic;
            color: #ccc;
            font-size: 12px;
            width: 100%;
        }

        #map { 
            height: 300px; 
            margin-top: 20px; 
            border-radius: 8px;
            overflow: hidden;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 600px;
        }
        
        th, td { 
            border: 1px solid #ccc; 
            padding: 8px; 
            text-align: left; 
            font-size: 12px;
        }
        
        th { 
            background-color: #f2f2f2; 
            color: #051937; 
            position: sticky;
            top: 0;
        }

        .uf-marker .uf-badge {
            width: 32px;
            height: 32px;
            border-radius: 16px;
            background: #1e88e5;
            color: #fff;
            border: 2px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 0 6px rgba(0,0,0,0.3);
            font-size: 12px;
        }

        .loading {
            color: #a855f7;
            font-weight: bold;
        }

        /* Media queries para responsividade */
        @media (max-width: 768px) {
            body {
                margin: 5px;
                font-size: 12px;
            }

            .header {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .header h1 {
                font-size: 1.2rem;
                min-width: auto;
            }

            .logo-container {
                margin-left: 0;
            }

            .logo-container img {
                height: 150px;
            }

            .filters {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .filter-group {
                min-width: auto;
                width: 100%;
            }

            .filters select {
                width: 100%;
                padding: 12px;
                font-size: 16px; /* Evita zoom no iOS */
            }

            .message {
                text-align: center;
                margin-top: 15px;
            }

            #map {
                height: 250px;
                margin-top: 15px;
            }

            .uf-marker .uf-badge {
                width: 28px;
                height: 28px;
                border-radius: 14px;
                font-size: 11px;
            }

            th, td {
                padding: 6px;
                font-size: 11px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1rem;
            }

            .logo-container img {
                height: 100px;
            }

            #map {
                height: 200px;
            }

            .uf-marker .uf-badge {
                width: 24px;
                height: 24px;
                border-radius: 12px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body style="background-image: linear-gradient(to right top, #051937, #0b2052, #23246b, #432381, #051937);">
    <div class="header">
        <h1>Faculdades de Desenvolvimento de Software</h1>
        <div class="logo-container">
            <img src="devguia-logo.png" alt="DevGuia" onclick="window.open('https://devguia.com.br', '_blank')">
        </div>
    </div>
    
    <div class="filters">
        <div class="filter-group">
            <label for="uf">Estado (UF):</label>
            <select id="uf">
                <option value="">Selecione...</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="municipio">Município:</label>
            <select id="municipio">
                <option value="">Selecione primeiro o estado</option>
            </select>
        </div>

        <div class="message" id="message">Selecione o Estado e Cidade para ver os cursos</div>
    </div>

    <div id="map"></div>

    <div class="table-container">
        <table id="tabela" style="display: none;">
            <thead>
                <tr>
                    <th>Instituição</th>
                    <th>Curso</th>
                    <th>Modalidade</th>
                    <th>Município</th>
                    <th>UF</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        let dadosCache = new Map();
        let mapa = L.map('map').setView([-14.2350, -51.9253], 4);
        let marcadores = [];

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(mapa);

        const UFS = ['AC', 'AL', 'AM', 'AP', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA', 'MG', 'MS', 'MT', 'PA', 'PB', 'PE', 'PI', 'PR', 'RJ', 'RN', 'RO', 'RR', 'RS', 'SC', 'SE', 'SP', 'TO'];

        const UF_COORDS = {
            AC: [-9.9754, -67.8243], AL: [-9.6498, -35.7089], AM: [-3.1190, -60.0217],
            AP: [0.0349, -51.0694], BA: [-12.9777, -38.5016], CE: [-3.7167, -38.5426],
            DF: [-15.7939, -47.8828], ES: [-20.3155, -40.3128], GO: [-16.6809, -49.2539],
            MA: [-2.5307, -44.3068], MG: [-19.9167, -43.9345], MS: [-20.4697, -54.6201],
            MT: [-15.6010, -56.0974], PA: [-1.4558, -48.4902], PB: [-7.1195, -34.8450],
            PE: [-8.0476, -34.8770], PI: [-5.0919, -42.8034], PR: [-25.4296, -49.2713],
            RJ: [-22.9068, -43.1729], RN: [-5.7945, -35.2110], RO: [-8.7611, -63.9039],
            RR: [2.8235, -60.6753], RS: [-30.0346, -51.2177], SC: [-27.5949, -48.5482],
            SE: [-10.9162, -37.0677], SP: [-23.5505, -46.6333], TO: [-10.1840, -48.3336]
        };

        const geocodeCache = new Map();

        async function getMunicipioLatLng(uf, municipio) {
            const key = `${municipio}-${uf}`;
            if (geocodeCache.has(key)) return geocodeCache.get(key);

            const q = `${municipio}, ${uf}, Brasil`;
            const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&countrycodes=br&q=${encodeURIComponent(q)}`;

            try {
                const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
                const data = await resp.json();
                if (Array.isArray(data) && data.length) {
                    const latlng = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                    geocodeCache.set(key, latlng);
                    return latlng;
                }
            } catch (e) {
                console.warn('Falha na geocodificação:', municipio, uf, e);
            }
            geocodeCache.set(key, null);
            return null;
        }

        async function carregarDadosUF(uf) {
            if (dadosCache.has(uf)) {
                return dadosCache.get(uf);
            }

            document.getElementById("message").innerHTML = '<span class="loading">Carregando dados...</span>';

            return new Promise((resolve, reject) => {
                Papa.parse("cursos_desenvolvimento_software.csv", {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        const dadosUF = results.data.filter(d => d.uf === uf);
                        dadosCache.set(uf, dadosUF);
                        resolve(dadosUF);
                    },
                    error: function(err) {
                        console.error("Erro ao carregar CSV:", err);
                        reject(err);
                    }
                });
            });
        }

        async function atualizarMapa(lista) {
            marcadores.forEach(m => mapa.removeLayer(m));
            marcadores = [];

            const ufSelecionada = document.getElementById("uf").value;
            const municipioSelecionado = document.getElementById("municipio").value;

            if (municipioSelecionado && lista.length > 0) {
                const totalMunicipio = lista.length;
                const latlng = await getMunicipioLatLng(ufSelecionada, municipioSelecionado);
                if (latlng) {
                    const icon = L.divIcon({
                        className: 'uf-marker',
                        html: `<div class="uf-badge">${totalMunicipio}</div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });
                    const marcador = L.marker(latlng, { icon }).addTo(mapa);
                    marcador.bindPopup(`<b>${municipioSelecionado} - ${ufSelecionada}</b><br>${totalMunicipio} curso(s)`);
                    marcadores.push(marcador);
                    mapa.setView(latlng, 11);
                }
            } else if (ufSelecionada && lista.length > 0) {
                const totalUF = lista.length;
                const coord = UF_COORDS[ufSelecionada];
                if (coord) {
                    const icon = L.divIcon({
                        className: 'uf-marker',
                        html: `<div class="uf-badge">${totalUF}</div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });
                    const marcador = L.marker(coord, { icon }).addTo(mapa);
                    marcador.bindPopup(`<b>${ufSelecionada}</b><br>${totalUF} curso(s)`);
                    marcadores.push(marcador);
                    mapa.setView(coord, 6);
                }
            }
        }

        function atualizarTabela(lista) {
            const tabela = document.getElementById("tabela");
            const corpo = document.querySelector("#tabela tbody");
            
            if (lista.length === 0) {
                tabela.style.display = "none";
                return;
            }

            corpo.innerHTML = "";
            lista.forEach(item => {
                const linha = document.createElement("tr");
                linha.innerHTML = `<td>${item.nome_ies}</td><td>${item.nome_curso}</td><td>${item.modalidade}</td><td>${item.municipio}</td><td>${item.uf}</td>`;
                corpo.appendChild(linha);
            });
            tabela.style.display = "table";
        }

        function init() {
            const ufSelect = document.getElementById("uf");
            const municipioSelect = document.getElementById("municipio");
            const messageEl = document.getElementById("message");

            UFS.forEach(uf => {
                const option = document.createElement("option");
                option.value = uf;
                option.textContent = uf;
                ufSelect.appendChild(option);
            });

            ufSelect.addEventListener("change", async () => {
                const uf = ufSelect.value;
                municipioSelect.innerHTML = '<option value="">Carregando...</option>';
                
                if (!uf) {
                    municipioSelect.innerHTML = '<option value="">Selecione primeiro o estado</option>';
                    messageEl.textContent = "Selecione o Estado e Cidade para ver os cursos";
                    atualizarTabela([]);
                    marcadores.forEach(m => mapa.removeLayer(m));
                    marcadores = [];
                    mapa.setView([-14.2350, -51.9253], 4);
                    return;
                }

                try {
                    const dados = await carregarDadosUF(uf);
                    const municipios = [...new Set(dados.map(d => d.municipio).filter(Boolean))].sort();
                    
                    municipioSelect.innerHTML = '<option value="">Todos os municípios</option>';
                    municipios.forEach(municipio => {
                        const option = document.createElement("option");
                        option.value = municipio;
                        option.textContent = municipio;
                        municipioSelect.appendChild(option);
                    });

                    messageEl.textContent = `${dados.length} curso(s) encontrado(s) em ${uf}`;
                    await atualizarMapa(dados);
                    atualizarTabela(dados);
                } catch (err) {
                    messageEl.innerHTML = '<span style="color: red;">Erro ao carregar dados</span>';
                }
            });

            municipioSelect.addEventListener("change", async () => {
                const uf = ufSelect.value;
                const municipio = municipioSelect.value;
                
                if (!uf) return;

                const dados = dadosCache.get(uf) || [];
                const filtrados = municipio ? dados.filter(d => d.municipio === municipio) : dados;
                
                const local = municipio ? `${municipio} - ${uf}` : uf;
                messageEl.textContent = `${filtrados.length} curso(s) encontrado(s) em ${local}`;
                
                await atualizarMapa(filtrados);
                atualizarTabela(filtrados);
            });
        }

        init();
    </script>
</body>
</html>
